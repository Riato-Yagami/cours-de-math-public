% Switch implementation

\newboolean{default}
\newcommand{\case}{}
\newcommand{\default}{}

\newenvironment{switch}[1]{%
    \setboolean{default}{true}
    \renewcommand{\case}[2]{\ifthenelse{\equal{#1}{##1}}{%
        \setboolean{default}{false}##2}{}}%
    \renewcommand{\default}[1]{\ifthenelse{\boolean{default}}{##1}{}}
}{}

% SECTIONS
\input{header/command/sections.tex}

% COURSE AUX NOMBRES
\input{header/command/can.tex}

% ANSWERS
\newlength{\parline}
\newlength{\paroutindent}
\newlength{\lineheight}
\setlength{\lineheight}{\heightof{abcdefghijklmnoprstuvwxyz}}

\newcommand{\countlines}[1]{%
    \setlength{\paroutindent}{\expandafter\parindent}
    \setlength{\parline}{\heightof{\noindent\begin{minipage}{\linewidth}%
                \setlength{\parindent}{\paroutindent}#1\end{minipage}}}%
    \pgfmathparse{round(\parline / (0.9*\lineheight))}
    \newcount\linecount
    \pgfmathsetcount{\linecount}{\pgfmathresult}
}

\newcommand{\looptext}[2]{%
    \noindent
    \newcount\printcount
    \printcount=#2
    \loop
        #1
        \advance\printcount by -1
        \ifnum\printcount>0
    \repeat
}

\newcommand{\awsr}[1]{%
    \ifthenelse{\boolean{answer}}{
        \result{#1}
    }{
        \countlines{#1}
        \pgfmathsetcount{\linecount}{\linecount + 1}
        \noindent\hspace{-9pt}
        \looptext{
            \noindent\dotfill
    
        }{\the\linecount}
    }
}

\newcommand{\bawsr}[1]{%
    \ifthenelse{\boolean{answer}}{%
        \result{#1}%
    }{%
        \dotfill%
    }%
}

% \newcommand{\dottedLines}[1]{%
%     \noindent\hspace{-9pt}%
%     \ifthenelse{\equal{#1}{0}}{}{%
%         \looptext{%
%         \noindent\dotfill%

%         }{#1}
%     }
% }

\newcounter{loopcntr}
\newcommand{\dottedLines}[1]{%
    \noindent\hspace{-9pt}%
    \ifthenelse{\equal{#1}{0}}{}{%
        \setcounter{loopcntr}{0}%
        \looptext{%
        {\ifthenelse{\isodd{\value{loopcntr}}}{\color{gradeColor!55}}{}%
        \noindent\dotfill}%

        \stepcounter{loopcntr}}{#1}%
    }
}

\def\resultColor{OrangeRed}
\newcommand{\result}[1]{\textcolor{\resultColor}{#1}}

% MATH
\input{header/command/math.tex}

% IMAGES
\input{header/command/image.tex}

% COMMANDS

\newcommand{\fsize}[1]{\fontsize{#1}{#1}\selectfont}

\NewDocumentCommand{\ifempty}{m m O{}}{%
    \ifstrempty{#1}%
        {%
            #2%
        }{%
            #3%
        }%
}

\NewDocumentCommand{\ifNotNull}{mmo}{%
    \IfValueT{#1}{%
        \ifx\relax#1\relax%
            \IfValueT{#3}{%
                #3%
            }%
        \else%
            #2%
        \fi%
    }%
}%

\NewDocumentCommand{\ilink}{m g}{%
    \item
    \IfValueTF{#2}{\link{#1}{#2}}{\link{#1}}
}

\NewDocumentCommand{\link}{m g}{%
    \csn{#1}%
    \IfValueT{#2}{(#2)}%
}

\NewDocumentCommand{\TODO}{g}{%
    {\color{Red} $\rightarrow$ \textbf{TODO}
    \IfValueT{#1}{(#1)}}
    % \color{black}
}

\newcommand{\leconInfoBox}[2]{
    \textbf{#1 :}\vspace{-0.25cm}
        \begin{multicols}{2}
            \begin{itemize}[label=$\blacktriangleright$, font = \small \color{Red}]
                #2
            \end{itemize}
        \end{multicols}
        \vspace{-0.4cm}
}

% TCOLORBOX

\input{header/command/tcolorbox.tex}

\NewDocumentCommand{\leconInfo}{mooo}{
    \begin{infoBox}
        \leconInfoBox{Niveaux}{#1}
        \ifNotNull{#2}{
            \tcbline
            \leconInfoBox{Prérequis}{#2}
        }
        \ifNotNull{#3}{
            \tcbline
            \leconInfoBox{Thèmes}{#3}
        }
        \ifNotNull{#4}{
            \tcbline
            \textbf{Motivation :} 
            #4
        }
    \end{infoBox}
}

\NewDocumentCommand{\seanceInfo}{oooooooo}{
    \begin{infoBox}
        \vspace{-0.05cm}
        \begin{tcbitemize}[raster rows=1,raster columns=20,raster height=1.65cm,
            raster every box/.style={colframe=red!50!black,colback=red!10!white}]
            \tcbitem[raster multicolumn=6] \textbf{Date :} #1
            \tcbitem[raster multicolumn=10] \textbf{Séquence :} #2
            \tcbitem[raster multicolumn=4] \textbf{Séance :} #3
        \end{tcbitemize}
        \vspace{-0.25cm}
        \ifNotNull{#4}{\tcbline \textbf{Objectif :} #4}
        \ifNotNull{#5}{\tcbline \leconInfoBox{Classe(s)}{#5}}
        \ifNotNull{#6}{\tcbline \leconInfoBox{Prérequi(s)}{#6}}
        \ifNotNull{#7}{\tcbline \textbf{Séance précédente :} #7}
        \ifNotNull{#7}{\tcbline \leconInfoBox{Matériel(s)}{#8}}
    \end{infoBox}
}

\def\pDscr{\tcbitem[enhanced jigsaw, breakable,
    raster multicolumn=6]
}
\def\pMdlt{\tcbitem[enhanced jigsaw, breakable,
    raster multicolumn=11]
}
\def\pTime{\tcbitem[enhanced jigsaw, breakable,
    raster multicolumn=3, halign=center]
}

\newcommand{\prepRow}[3]{
    \tcbitem[raster multicolumn=20]
    \tcblower

    \pDscr #1
    \pMdlt #2
    \pTime #3
}

\newcommand{\prepTable}[1]{
    \begin{prepBox}
        \begin{tcbitemize}[enhanced jigsaw, breakable, raster rows=1,raster columns=20,raster height=1.1cm, halign=center,
            raster every box/.style={enhanced jigsaw, breakable, colframe=Blue!50!black,colback=Blue!10!white}]
            \pDscr \textbf{Descriptif}
            \pMdlt \textbf{Modalité}
            \pTime \textbf{Durée}
        \end{tcbitemize}
        \begin{tcbitemize}[enhanced jigsaw, breakable,
            raster equal height = rows, 
            raster columns=20, frame hidden,
            raster every box/.style={
                enhanced jigsaw, breakable,
                opacityback=0, valign=top, 
                size = tight
            }]
            #1
        \end{tcbitemize}
    \end{prepBox}
}

% TIKZ

\NewDocumentCommand{\ctikz}{O{0.5} m}{
    \begin{center}
        \begin{tikzpicture}[scale = #1]
            #2
        \end{tikzpicture}
    \end{center}
}

\newcommand{\axis}[1]{%Draw coordinate axes
    \draw[thin, -Stealth] (-0.5,0) -- (#1,0);% node[right] {$x$}; % x-axis
    \draw[thin, -Stealth] (0,-0.5) -- (0,#1);% node[above] {$y$}; % y-axis
}

\newcommand{\drawGrid}[3]{
    \foreach \n in {0,...,#1}
        \draw[line width = #3] (\n,0) -- (\n,#2);
    \foreach \n in {0,...,#2}
        \draw[line width = #3] (0,\n) -- (#1,\n);
}

\def\crossSize{0.25}
\NewDocumentCommand{\drawPoint}{mmm O{\pointColor} O{(0,0)}}{
    \node[shift={#5}, color = #4] at (#2 - 0.5,#3 - 0.5) {#1};
    \draw[line width = \crossWidth, shift={#5}, color = #4] (#2 - \crossSize,#3) -- (#2 + \crossSize,#3);
    \draw[line width = \crossWidth, shift={#5}, color = #4] (#2,#3 -\crossSize) -- (#2,#3 + \crossSize);
}

\NewDocumentCommand{\drawTick}{m O{} O{gradeColor}}{
    \draw[line width = 0.75mm, #3] (#1, 0.08) -- (#1, -0.08);
    \draw[line width = 0.75mm, #3] (#1 - 0.08, 0) -- (#1 + 0.08, 0);
    \node[#3] at (#1, -0.3) {#2};
}

% Tabular
\newcolumntype{C}[1]{>{\centering\arraybackslash}p{#1}}
\newcolumntype{D}{>{\centering\arraybackslash}p{\cW}}
\newcolumntype{M}[1]{>{\centering\arraybackslash}m{#1}}
\newcolumntype{K}{@{}m{0pt}@{}}

% GEOMETRY

\newcommand{\multiColItemize}[2]{
    \ifthenelse{\isequivalentto{#1}{1}}{
        \begin{itemize}
            #2
        \end{itemize}
    }{
        \begin{multicols}{#1}
            \begin{itemize}
                #2
            \end{itemize}
        \end{multicols}
    }
}

\newcommand{\multiColEnumerate}[2]{
    \ifthenelse{\isequivalentto{#1}{1}}{
        \begin{enumerate}
            #2
        \end{enumerate}
    }{
        \begin{multicols}{#1}
            \begin{enumerate}
                #2
            \end{enumerate}
        \end{multicols}
    }
}

\makeatletter
\newcommand\pgfinvisible{\pgfsys@begininvisible}
\newcommand\pgfshown{\pgfsys@endinvisible}
\makeatother

\renewcommand*{\phantom}[1]{
    \pgfinvisible #1 \pgfshown
}

\newcounter{size}
\newcommand{\listSize}[1]{%
    \setcounter{size}{0}%
    \foreach \n in {#1}{\stepcounter{size}}%
    % \thesize
}

\newcounter{elemPos}
\newcommand{\listElement}[2]{
    \setcounter{elemPos}{0} % Start counting from 1
    \def\resultVal{0} % Default value
    \renewcommand*{\do}[1]{%
        \ifnumequal{\value{elemPos}}{#2}{%
            \def\resultVal{##1}%
            \listbreak% Break out of the loop
        }{}%
        \stepcounter{elemPos}%
    }
    % \docsvlist{#1}
    \expandafter\docsvlist\expandafter{#1} % Expand the list before passing it to \docsvlist
    \resultVal
}

% \NewDocumentCommand{\exoslide}{m O{10cm}}{
%     \slide{}{
%         \img{\imgf{#1}}[#2]
%     }
% }

\NewDocumentCommand{\transformList}{m}{
    % Split the input by commas and iterate over the elements
    \foreach \i in {#1} {%
        manuel/\i,%
    }
}

% \NewDocumentCommand{\removeFirstChar}{m}{
%     % Get the input string
%     \def\inputString{#1}
%     % Create a new command to hold the output string
%     \def\outputString{}
    
%     % Get the length of the input string
%     \newcount\stringLength
%     \stringLength=\numexpr\expandafter\detokenize\expandafter{\inputString}\relax
%     \advance\stringLength by -1 % Decrease length by 1 to ignore the first character

%     % Check if the input string is not empty
%     \ifnum\stringLength>0
%         % Remove the first character by skipping it
%         \edef\outputString{\expandafter\@gobble\inputString} % Skip the first character
%         % Output the remaining string
%         \outputString
%     \else
%         % If the string is empty, output nothing
%         % Alternatively, you can output a message or a default value
%         \textbf{Empty string}
%     \fi
% }

\NewDocumentCommand{\bookSlide}{m O{10cm} O{1} O{\gradeBook} O{exo}}{%
    % \exoSlide{\foreach \q in {#1}{manuel/\q,}}
    {%
        \def\imgPrefix{manuel/}%
        \exoSlide{#1}[#2][#3][#4][#5]%
    }%
}

\def\caPrefix{}
\newcommand{\caSlide}[1]{%
    \slide{qf}{\nullsubsec{}{\imgp{ca/\caPrefix#1}[10cm]}[\ca]}
}

\NewDocumentCommand{\exoSlide}{m O{10cm} O{1} O{} O{exo}}{%
    \slide{#5}{%
        \ifthenelse{\equal{#3}{1}}{\vspace{-0.5cm}}{\vspace{-1cm}}
        \def\exercices{\foreach \q in {#1}{\imgp{\q}[#2]\vspace{-0.3cm}}}
        \exo{#1}{\wideFrame[7em]{\bvspace{0.25cm}\avspace{-0.25cm}
            \ifthenelse{\equal{#3}{1}}{\exercices}
            {\begin{multicols}{#3}\exercices\end{multicols}}}
            \avspace{0.75cm}
        }[#4]
    }
}

\NewDocumentCommand{\exoList}{m O{} O{3}}{%
    \section*{Exercices}%
    \slide{EXERCICES}{
        \exo{#2}{
            \vspace{-0.25cm}
            \multiColEnumerate{#3}{
                \foreach \q in {#1}{
                    \item \q
                }
            }
        }
    }
}

\newcommand{\questions}[1]{
    \begin{enumerate}
        \foreach \q in {#1}{
            \item \q\\
            \vspace*{-0.45cm}
            \dottedLines{3}
        }
    \end{enumerate}
}

\NewDocumentCommand{\answerFill}{O{Réponse} O{}}{%
    \answerSec{\remaininglines}[#1][#2]%
    \newpage%
}

\NewDocumentCommand{\answerSec}{m O{Réponse} O{}}{\vspace{0.25cm}%
    #2 : \ifempty{#3}{\quad \dottedLines{#1}}{\color{\resultColor}#3}
    % \ifNotNull{#3}{#2 : #3}{%
    %     #2 :%
    %     \quad \dottedLines{#1}%
    % }
}

% Define a new boolean for checking if the section is starred
\newboolean{section@star}

\makeatletter
% Redefine \section and \section* to set the boolean
\let\old@section\section
\renewcommand{\section}{%
    \@ifstar
        {\setboolean{section@star}{true}\old@section*}
        {\setboolean{section@star}{false}\old@section}%
}
\makeatother

\newcommand{\qt}[1]{«\textit{#1}»}

\newcommand{\calc}[1]{\numexpr#1\relax}
\newcommand{\ncalc}[1]{\number\calc{#1}}
\newcommand{\pcalc}[1]{\numprint{\ncalc{#1}}}

\def\gradeBook{}
\newcommand{\setGrade}[1]{
    \def\grade{#1}
    % \begin{switch}{#1}
    %     \case{6e}{\global\definecolor{gradeColor}{hex}{FA8072}}
    %     \default{
    %         Default
    %         \global\definecolor{gradeColor}{RGB}{200, 50, 50}
    %     }
    % \end{switch}
    \ifthenelse{\equal{#1}{6e}}{
        \def\gradeBook{\dim}
        \definecolor{gradeColor}{HTML}{C6233D} % FA8072 in hex
    }{
    \ifthenelse{\equal{#1}{5e}}{
        \def\gradeBook{\mm}
        \definecolor{gradeColor}{HTML}{088255}
    }{
    \ifthenelse{\equal{#1}{4e}}{
        \def\gradeBook{\mi}
        \definecolor{gradeColor}{HTML}{1466A8}
    }{
    \ifthenelse{\equal{#1}{3e}}{
        \definecolor{gradeColor}{HTML}{844499}
    }{
        \definecolor{gradeColor}{RGB}{0, 0, 0}
    }}}}
}

\gdef\phase{}
\newcommand{\setPhase}[1]{%
    \begin{switch}{#1}
        \case{exo}{\gdef\phase{EXERCICES}}
        \case{cr}{\gdef\phase{COURS}}
        \case{qf}{\gdef\phase{QUESTIONS FLASH}}
        \case{dm}{\gdef\phase{DEVOIR MAISON}}
        \default{\gdef\phase{#1}}
    \end{switch}
}

\newcounter{savedenumi}
\setcounter{savedenumi}{0}
\xdef\savedenumi{0}
% \newcommand{\saveenumi}{
%     % \xdef\savedenumi{\calc{\theenumi-1}}
%     \setcounter{savedenumi}{0}
% }

\newcommand{\saveenumi}[1]{
    \setcounter{savedenumi}{#1}
}

\newcommand{\loadenumi}{
    % \setItemColor{\currentColor}
    \setcounter{enumi}{\thesavedenumi}
}

\newcommand{\setSeq}[2]{%
    \setcounter{seq}{#1}
    \setTitle{#2}
    \bseq{#2}
}

\newcommand{\setTitle}[1]{%
    \def\longTitle{#1}
    \def\shortTitle{\MakeUppercase{\longTitle}}
    \def\title{\textbf{\color{Red} #1}}
}

% Cases

\newcommand{\kebabCase}[1]{%
    \def\temp{#1}%
    \StrSubstitute{\temp}{é}{e}[\temp]%
    \StrSubstitute{\temp}{è}{e}[\temp]%
    \StrSubstitute{\temp}{ê}{e}[\temp]%
    \StrSubstitute{\temp}{à}{a}[\temp]%
    \StrSubstitute{\temp}{â}{a}[\temp]%
    \StrSubstitute{\temp}{î}{i}[\temp]%
    \StrSubstitute{\temp}{ï}{i}[\temp]%
    \StrSubstitute{\temp}{ç}{c}[\temp]%
    \StrSubstitute{\temp}{ }{-}[\temp]%
    \MakeLowercase{\temp}%
}

\newcommand{\reverseSnakeCase}[1]{%
    \def\temp{#1}%
    \StrSubstitute{\temp}{_}{ }[\temp]%
    \temp
}

\newcommand{\reverseKebabCase}[1]{%
    \def\temp{#1}%
    \StrSubstitute{\temp}{-}{ }[\temp]%
    \temp
}

% Helper command to add rows to the table
\def\evaluationRow#1/#2!{\ifthenelse{\equal{#2}{0}}{\bonus }{}#1 &
    \ifthenelse{\equal{#2}{0}}{}{\qquad/ #2}
    \addtocounter{evaluationTotal}{#2}\\ \hline
}

% Command to generate the sequence evaluation table
\newcommand{\seqEvaluation}[3]{ % 1: Sequence number, 2: Title, 3: Competences
    \renewcommand{\arraystretch}{1.2}
    \renewcommand*\do[1]{\evaluationRow##1!}
    \begin{seqEvaluationBox}{#1}{#2}
        \begin{center}
            \begin{tabular}{p{0.83\linewidth}|C{0.1\linewidth}} % Table column widths
                \hline
                \docsvlist{#3} % Process the list of competencies and notes
            \end{tabular}
        \end{center}
    \end{seqEvaluationBox}
}

\def\evalutionTotal{
    \begin{evaluationBox}
        \begin{flushright}
            / \theevaluationTotal
        \end{flushright}
        
    \end{evaluationBox}
}

\def\evalutionEnd{
    \seqEvaluation{}{Compétences générales}{
        Écrire ses calculs
        /3,
        Rédiger des phrases réponses
        /2
    }
    \evalutionTotal
    \vspace{-2cm}
}

\newcommand{\tp}[1]{
    \setTitle{TP : #1}
    \thispagestyle{assignment}
    \setboolean{showSubID}{true}
    \emptyBackground
}

\newcommand{\evaluation}[1]{
    \setTitle{Evaluation #1}
    \thispagestyle{assignment}
    \setboolean{showSubID}{true}
    \emptyBackground
}

\newcommand{\repeated}[2]{% \repeat already defined
    \foreach \n in {1,...,#1}{#2}
}

\newcommand{\remaininglines}{
    \the\numexpr (\textheight - \pagetotal) / \baselineskip - 1 \relax
}

\newcommand{\print}{%
    \setboolean{answer}{false}
    \setboolean{newPageOnSlide}{true}
}